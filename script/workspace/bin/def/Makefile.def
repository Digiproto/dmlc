# The file is created by eJim Lee (lyjforjob@gmail.com)

# extra library directory
EXTRA_LIBRARY=

# set environment variable
QEMU_DIR=@QEMU_DIR@
QEMU_INSTALL_DIR=@QEMU_INSTALL_DIR@
SKYEYE_DIR=@SKYEYE_DIR@
SKYEYE_INSTALL_DIR=@SKYEYE_INSTALL_DIR@
QEMU_CONF_FLAGS=@QEMU_CONF_FLAGS@
SKYEYE_CONF_FLAGS=@SKYEYE_CONF_FLAGS@
DMLC=@DMLC@
MAKE+= -j2
PYTHON=@PYTHON@

# get current device name
CURR_DIR=$(shell pwd)
OBJ_NAME=$(shell basename $(CURR_DIR))

# set QEMU and Skyeye path
QEMU_DIR_IN=$(QEMU_DIR)/hw/simics/$(OBJ_NAME)
SKYEYE_DIR_IN=../../targets/skyeye/$(OBJ_NAME)
EXTRA_LIBRARY_DIR=$(foreach var,$(EXTRA_LIBRARY),../../interface/$(var))
EXTRA_LIBRARY_FILE=$(foreach var,$(EXTRA_LIBRARY),../../interface/$(var)/$(var).dml)
EXTRA_INCLUDE_FILE=$(foreach var,$(EXTRA_LIBRARY),$(wildcard ../../interface/$(var)/*.h))
#SKYEYE_DIR_IN=$(SKYEYE_DIR)/device/simics/$(OBJ_NAME)

# set target device name
QEMU_OBJ=$(QEMU_DIR_IN)/$(OBJ_NAME).o
ifeq ($(shell uname),Linux)
	SKYEYE_OBJ=$(SKYEYE_DIR_IN)/lib$(OBJ_NAME).so
else
	SKYEYE_OBJ=$(SKYEYE_DIR_IN)/lib$(OBJ_NAME).dll
endif

@FOR_QEMU@qemu: $(QEMU_DIR_IN)/$(OBJ_NAME).c \
@FOR_QEMU@	     $(QEMU_DIR_IN)/$(OBJ_NAME).h \
@FOR_QEMU@	     $(QEMU_DIR_IN)/$(OBJ_NAME)_protos.c \
@FOR_QEMU@	     $(QEMU_DIR_IN)/$(OBJ_NAME)_struct.h

@FOR_SKYEYE@skyeye: $(SKYEYE_DIR_IN)/$(OBJ_NAME).c \
@FOR_SKYEYE@	       $(SKYEYE_DIR_IN)/$(OBJ_NAME).h \
@FOR_SKYEYE@	       $(SKYEYE_DIR_IN)/$(OBJ_NAME)_module.c \
@FOR_SKYEYE@	       $(SKYEYE_DIR_IN)/$(OBJ_NAME)_protos.c \
@FOR_SKYEYE@	       $(SKYEYE_DIR_IN)/$(OBJ_NAME)_struct.h

@FOR_QEMU@$(QEMU_DIR_IN)/$(OBJ_NAME).c \
@FOR_QEMU@$(QEMU_DIR_IN)/$(OBJ_NAME).h \
@FOR_QEMU@$(QEMU_DIR_IN)/$(OBJ_NAME)_protos.c \
@FOR_QEMU@$(QEMU_DIR_IN)/$(OBJ_NAME)_struct.h: $(OBJ_NAME).dml $(EXTRA_LIBRARY_FILE) $(EXTRA_INCLUDE_FILE)
@FOR_QEMU@	@echo [  gdml] translate $(OBJ_NAME).dml to QEMU C codes
@FOR_QEMU@	@mkdir -p output
@FOR_QEMU@ifeq ($(EXTRA_LIBRARY),)
@FOR_QEMU@	@$(DMLC)_qemu $(OBJ_NAME).dml
@FOR_QEMU@else
@FOR_QEMU@	@$(DMLC)_qemu $(OBJ_NAME).dml -L $(EXTRA_LIBRARY_DIR)
@FOR_QEMU@	@cp $(EXTRA_INCLUDE_FILE) $(QEMU_DIR_IN)
@FOR_QEMU@endif
@FOR_QEMU@	@cp output/* $(QEMU_DIR_IN)
@FOR_QEMU@	@rm -rf output

@FOR_SKYEYE@$(SKYEYE_DIR_IN)/$(OBJ_NAME).c \
@FOR_SKYEYE@$(SKYEYE_DIR_IN)/$(OBJ_NAME).h \
@FOR_SKYEYE@$(SKYEYE_DIR_IN)/$(OBJ_NAME)_module.c \
@FOR_SKYEYE@$(SKYEYE_DIR_IN)/$(OBJ_NAME)_protos.c \
@FOR_SKYEYE@$(SKYEYE_DIR_IN)/$(OBJ_NAME)_struct.h: $(OBJ_NAME).dml $(EXTRA_LIBRARY_FILE) $(EXTRA_INCLUDE_FILE)
@FOR_SKYEYE@	@echo [  gdml] translate $(OBJ_NAME).dml to SKYEYE C codes
@FOR_SKYEYE@	@mkdir -p output
@FOR_SKYEYE@ifeq ($(EXTRA_LIBRARY),)
@FOR_SKYEYE@	@$(DMLC)_skyeye $(OBJ_NAME).dml
@FOR_SKYEYE@else
@FOR_SKYEYE@	@$(DMLC)_skyeye $(OBJ_NAME).dml -L $(EXTRA_LIBRARY_DIR)
@FOR_SKYEYE@	@cp $(EXTRA_INCLUDE_FILE) $(SKYEYE_DIR_IN)
@FOR_SKYEYE@endif
@FOR_SKYEYE@	@cp output/* $(SKYEYE_DIR_IN)
@FOR_SKYEYE@	@rm -rf output

test: test.py
	@$(PYTHON) test.py

clean:
@FOR_QEMU@	-rm -rf $(QEMU_DIR_IN)/$(OBJ_NAME).c \
@FOR_QEMU@		$(QEMU_DIR_IN)/$(OBJ_NAME).h \
@FOR_QEMU@		$(QEMU_DIR_IN)/$(OBJ_NAME)_protos.c \
@FOR_QEMU@		$(QEMU_DIR_IN)/$(OBJ_NAME)_struct.h \
@FOR_QEMU@		$(foreach var,$(EXTRA_LIBRARY),$(QEMU_DIR_IN)/$(var).h)
@FOR_SKYEYE@	-rm -rf $(SKYEYE_DIR_IN)/$(OBJ_NAME).c \
@FOR_SKYEYE@		$(SKYEYE_DIR_IN)/$(OBJ_NAME).h \
@FOR_SKYEYE@		$(SKYEYE_DIR_IN)/$(OBJ_NAME)_module.c \
@FOR_SKYEYE@		$(SKYEYE_DIR_IN)/$(OBJ_NAME)_protos.c \
@FOR_SKYEYE@		$(SKYEYE_DIR_IN)/$(OBJ_NAME)_struct.h \
@FOR_SKYEYE@		$(foreach var,$(EXTRA_LIBRARY),$(SKYEYE_DIR_IN)/$(var).h)

distclean: clean
@FOR_QEMU@	-rm -rf $(QEMU_OBJ)
@FOR_SKYEYE@	-rm -rf $(SKYEYE_DIR_IN)/$(OBJ_NAME).o \
@FOR_SKYEYE@		$(SKYEYE_DIR_IN)/$(OBJ_NAME)_module.o \
@FOR_SKYEYE@		$(SKYEYE_OBJ)

.PHONY: clean distclean
